<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>Все аренды - Админ-панель</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
<header>
    <nav>
        <div class="logo">
            <a th:href="@{/}">АвтоПрокат</a>
        </div>
        <ul class="nav-links">
            <li><a th:href="@{/}">Главная</a></li>
            <li><a th:href="@{/cars}">Автомобили</a></li>
            <li sec:authorize="isAuthenticated()"><a th:href="@{/rentals}">Мои аренды</a></li>
            <li sec:authorize="hasRole('ADMIN')"><a th:href="@{/admin/dashboard}" class="active">Админ-панель</a></li>
            <li sec:authorize="isAuthenticated()"><a th:href="@{/auth/logout}">Выйти</a></li>
        </ul>
    </nav>
</header>

<main class="container">
    <div class="admin-header">
        <h1>Управление арендами</h1>
        <div class="admin-nav">
            <a th:href="@{/admin/dashboard}" class="admin-nav-item">Панель управления</a>
            <a th:href="@{/cars}" class="admin-nav-item">Автомобили</a>
            <a th:href="@{/rentals/all}" class="admin-nav-item active">Аренды</a>
            <a th:href="@{/admin/users}" class="admin-nav-item">Пользователи</a>
        </div>
    </div>

    <!-- Отображение сообщений об успехе или ошибке -->
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <div class="admin-content">
        <div class="admin-filters">
            <div class="rental-tabs">
                <button class="tab-btn active" data-status="all">Все</button>
                <button class="tab-btn" data-status="PENDING">Ожидающие</button>
                <button class="tab-btn" data-status="ACTIVE">Активные</button>
                <button class="tab-btn" data-status="COMPLETED">Завершенные</button>
                <button class="tab-btn" data-status="CANCELLED">Отмененные</button>
            </div>

            <div class="search-form">
                <input type="text" id="searchInput" placeholder="Поиск по имени клиента или автомобилю...">
                <button class="btn" onclick="searchRentals()">Найти</button>
            </div>
        </div>

        <div class="rentals-table-container">
            <table class="rentals-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Клиент</th>
                    <th>Автомобиль</th>
                    <th>Начало</th>
                    <th>Окончание</th>
                    <th>Стоимость</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="rental : ${rentals}" th:data-status="${rental.status}" class="rental-row">
                    <td th:text="${rental.id}">1</td>
                    <td th:text="${rental.user.fullName}">Иван Иванов</td>
                    <td th:text="${rental.car.brand + ' ' + rental.car.model + ' (' + rental.car.licensePlate + ')'}">Toyota Camry (А123БВ777)</td>
                    <td th:text="${#temporals.format(rental.startDate, 'dd.MM.yyyy HH:mm')}">01.01.2025 12:00</td>
                    <td th:text="${#temporals.format(rental.endDate, 'dd.MM.yyyy HH:mm')}">05.01.2025 12:00</td>
                    <td th:text="${rental.totalCost + ' ₽'}">15000 ₽</td>
                    <td>
                            <span class="status-badge"
                                  th:classappend="${rental.status == 'PENDING' ? 'pending' :
                                                   rental.status == 'ACTIVE' ? 'active' :
                                                   rental.status == 'COMPLETED' ? 'completed' : 'cancelled'}"
                                  th:text="${rental.status == 'PENDING' ? 'Ожидает' :
                                           rental.status == 'ACTIVE' ? 'Активна' :
                                           rental.status == 'COMPLETED' ? 'Завершена' : 'Отменена'}">
                                Статус
                            </span>
                    </td>
                    <td class="actions-cell">
                        <a th:href="@{/rentals/{id}(id=${rental.id})}" class="btn btn-small">Детали</a>
                        <!-- Добавляем кнопку "Одобрить" для аренд в статусе PENDING -->
                        <form th:if="${rental.status == 'PENDING'}"
                              th:action="@{/rentals/{id}/approve(id=${rental.id})}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-small btn-success"
                                    onclick="return confirm('Вы уверены, что хотите одобрить аренду?')">
                                Одобрить
                            </button>
                        </form>
                        <form th:if="${rental.status == 'PENDING' || rental.status == 'ACTIVE'}"
                              th:action="@{/rentals/{id}/complete(id=${rental.id})}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-small btn-primary"
                                    onclick="return confirm('Вы уверены, что хотите завершить аренду?')">
                                Завершить
                            </button>
                        </form>
                        <form th:if="${rental.status == 'PENDING' || rental.status == 'ACTIVE'}"
                              th:action="@{/rentals/{id}/cancel(id=${rental.id})}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-small btn-danger"
                                    onclick="return confirm('Вы уверены, что хотите отменить аренду?')">
                                Отменить
                            </button>
                        </form>
                    </td>
                </tr>
                <tr th:if="${rentals.empty}">
                    <td colspan="8" class="no-data">Нет данных об арендах</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<footer>
    <p>&copy; 2025 АвтоПрокат. Все права защищены.</p>
</footer>

<script>
    // Фильтрация аренд по статусу
    document.addEventListener('DOMContentLoaded', function() {
        const tabButtons = document.querySelectorAll('.tab-btn');
        const rentalRows = document.querySelectorAll('.rental-row');

        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Удаляем класс active у всех кнопок
                tabButtons.forEach(btn => btn.classList.remove('active'));
                // Добавляем класс active текущей кнопке
                this.classList.add('active');

                const status = this.getAttribute('data-status');

                // Показываем/скрываем строки в зависимости от выбранного статуса
                rentalRows.forEach(row => {
                    if (status === 'all' || row.getAttribute('data-status') === status) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        });
    });

    // Функция поиска аренд
    function searchRentals() {
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        const rentalRows = document.querySelectorAll('.rental-row');

        rentalRows.forEach(row => {
            const rowText = row.textContent.toLowerCase();
            if (rowText.includes(searchInput)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Обработчик события для поиска при нажатии Enter
    document.getElementById('searchInput').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            searchRentals();
        }
    });
</script>
</body>
</html>