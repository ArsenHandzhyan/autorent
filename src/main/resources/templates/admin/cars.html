<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:data-is-admin="${#authorization.expression('hasRole(''ADMIN'')')}" lang="ru">
<head th:replace="~{fragments/head :: head(pageTitle='Управление автомобилями - Автопрокат')}"></head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<main class="container py-5">
    <div class="page-header">
        <h1>Управление автомобилями</h1>
        <div class="d-flex gap-2">
            <a th:href="@{/admin/dashboard}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> Назад к панели
            </a>
            <a th:href="@{/cars/add}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Добавить автомобиль
            </a>
        </div>
    </div>

    <div class="table-responsive">
        <table class="data-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>Фото</th>
                <th>Марка</th>
                <th>Модель</th>
                <th>Год</th>
                <th>Гос. номер</th>
                <th>Цена/день</th>
                <th>Статус</th>
                <th>Действия</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="car : ${cars}">
                <td th:text="${car.id}">1</td>
                <td>
                    <img th:if="${car.images != null && !car.images.empty}" 
                         th:src="${car.images[0].imageUrl}" 
                         class="car-image"
                         alt="Фото автомобиля"
                         th:style="'transform: rotate(' + (${car.images[0].rotation} != null ? ${car.images[0].rotation} : 0) + 'deg);'">
                    <div th:unless="${car.images != null && !car.images.empty}" 
                         class="car-image d-flex align-items-center justify-content-center bg-light">
                        <i class="fas fa-car"></i>
                    </div>
                </td>
                <td th:text="${car.brand}">Toyota</td>
                <td th:text="${car.model}">Camry</td>
                <td th:text="${car.year}">2023</td>
                <td th:text="${car.licensePlate}">А123БВ777</td>
                <td th:text="${car.dailyRate + ' ₽'}">3000 ₽</td>
                <td>
                    <select class="status-select"
                            th:data-car-id="${car.id}"
                            th:data-previous-status="${car.status.name()}"
                            th:classappend="${'status-' + car.status.name().toLowerCase()}">
                        <option th:each="st : ${T(ru.anapa.autorent.model.CarStatus).values()}"
                                th:value="${st.name()}"
                                th:text="${st.getDisplayName()}"
                                th:selected="${st == car.status}"></option>
                    </select>
                </td>
                <td>
                    <div class="action-buttons">
                         <a th:href="@{/cars/{id}/status-history(id=${car.id})}" class="btn btn-info btn-sm" title="История статусов">
                            <i class="fas fa-history"></i>
                        </a>
                        <button class="btn btn-warning btn-sm toggle-maintenance-btn maintenance-on"
                                th:data-car-id="${car.id}"
                                data-in-maintenance="true"
                                th:classappend="${car.status == T(ru.anapa.autorent.model.CarStatus).MAINTENANCE ? 'd-none' : ''}"
                                title="На обслуживание">
                            <i class="fas fa-tools"></i>
                        </button>
                        <button class="btn btn-success btn-sm toggle-maintenance-btn maintenance-off"
                                th:data-car-id="${car.id}"
                                data-in-maintenance="false"
                                th:classappend="${car.status != T(ru.anapa.autorent.model.CarStatus).MAINTENANCE ? 'd-none' : ''}"
                                title="Снять с обслуживания">
                            <i class="fas fa-check"></i>
                        </button>
                        <a th:href="@{/cars/{id}(id=${car.id})}" class="btn btn-outline-primary btn-sm" title="Просмотр">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a th:href="@{/cars/{id}/edit(id=${car.id})}" class="btn btn-outline-warning btn-sm" title="Редактировать">
                            <i class="fas fa-edit"></i>
                        </a>
                        <form th:action="@{/cars/{id}/delete(id=${car.id})}" method="post" class="d-inline delete-car-form">
                            <button type="submit" class="btn btn-outline-danger btn-sm"
                                    title="Удалить">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</main>

<div th:replace="~{fragments/footer :: footer}"></div>

</body>
</html> 