<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head}">
    <title>Управление тестовыми данными - AutoRent</title>
</head>
<body>
    <!-- CSRF токен для JavaScript -->
    <input type="hidden" id="csrf" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    
    <div class="container-fluid">
        <div class="row">
            <!-- Боковая панель -->
            <nav th:replace="~{fragments/admin-sidebar :: sidebar}"></nav>
            
            <!-- Основной контент -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="fas fa-database"></i>
                        Управление тестовыми данными
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <a href="/admin/dashboard" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i>
                            Вернуться в админ-панель
                        </a>
                    </div>
                </div>

                <!-- Предупреждение -->
                <div class="alert alert-warning" role="alert">
                    <h4 class="alert-heading">
                        <i class="fas fa-exclamation-triangle"></i>
                        Внимание!
                    </h4>
                    <p>Эта страница предназначена для очистки и создания тестовых данных платежей. 
                    Все существующие платежи будут удалены и заменены новыми тестовыми данными.</p>
                    <hr>
                    <p class="mb-0">Используйте эту функцию только для тестирования системы!</p>
                </div>

                <!-- Карточки действий -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-trash-alt"></i>
                                    Очистка и создание тестовых данных
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    Удаляет все существующие платежи и создает новые тестовые данные 
                                    с правильными датами и статусами для тестирования функциональности.
                                </p>
                                <button id="cleanAndCreateBtn" class="btn btn-danger">
                                    <i class="fas fa-magic"></i>
                                    Очистить и создать тестовые данные
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-chart-bar"></i>
                                    Статистика платежей
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    Показывает текущую статистику платежей в логах приложения 
                                    для анализа состояния системы.
                                </p>
                                <button id="showStatisticsBtn" class="btn btn-info">
                                    <i class="fas fa-eye"></i>
                                    Показать статистику
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Результат операции -->
                <div id="resultContainer" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-info-circle"></i>
                                Результат операции
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="resultMessage"></div>
                        </div>
                    </div>
                </div>

                <!-- Информация о тестовых данных -->
                <div class="mt-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-info-circle"></i>
                                Информация о тестовых данных
                            </h5>
                        </div>
                        <div class="card-body">
                            <h6>Создаваемые тестовые платежи:</h6>
                            <ul>
                                <li><strong>Вчера:</strong> Обработанный платеж (PROCESSED)</li>
                                <li><strong>Сегодня:</strong> Обработанный платеж (PROCESSED)</li>
                                <li><strong>Завтра:</strong> Ожидающий обработки (PENDING)</li>
                                <li><strong>Послезавтра:</strong> Ожидающий обработки (PENDING)</li>
                                <li><strong>3 дня назад:</strong> Обработанный с предупреждением о превышении лимита (PROCESSED)</li>
                                <li><strong>4 дня назад:</strong> Обработанный с предупреждением о недостатке средств (PROCESSED)</li>
                                <li><strong>5 дней назад:</strong> Техническая ошибка (FAILED)</li>
                                <li><strong>6 дней назад:</strong> Обработанный платеж (PROCESSED)</li>
                                <li><strong>7 дней назад:</strong> Обработанный платеж (PROCESSED)</li>
                            </ul>
                            
                            <h6>Особенности тестовых данных:</h6>
                            <ul>
                                <li>Все даты корректные и соответствуют текущей дате</li>
                                <li>Сумма каждого платежа: 1,500.00 ₽</li>
                                <li>Различные статусы для тестирования всех сценариев</li>
                                <li>Детальные примечания для каждого типа платежа</li>
                                <li>Корректные временные метки создания и обработки</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- JavaScript -->
    <script th:src="@{/js/main.js}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Получаем CSRF токен
            const csrfElement = document.getElementById('csrf');
            if (!csrfElement) {
                console.error('CSRF токен не найден!');
                showResult(false, 'Ошибка безопасности: CSRF токен не найден. Пожалуйста, обновите страницу.');
                return;
            }
            
            const csrfHeader = csrfElement.name;
            const csrfToken = csrfElement.value;
            
            if (!csrfToken) {
                console.error('CSRF токен пустой!');
                showResult(false, 'Ошибка безопасности: CSRF токен пустой. Пожалуйста, обновите страницу.');
                return;
            }

            // Очистка и создание тестовых данных
            document.getElementById('cleanAndCreateBtn').addEventListener('click', function() {
                if (confirm('Вы уверены, что хотите удалить все существующие платежи и создать новые тестовые данные?')) {
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Обработка...';
                    
                    fetch('/test-data/clean-and-create-payments', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        },
                        credentials: 'same-origin'
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        showResult(data.success, data.message);
                    })
                    .catch(error => {
                        console.error('Ошибка при выполнении операции:', error);
                        showResult(false, 'Ошибка при выполнении операции: ' + error.message);
                    })
                    .finally(() => {
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-magic"></i> Очистить и создать тестовые данные';
                    });
                }
            });

            // Показать статистику
            document.getElementById('showStatisticsBtn').addEventListener('click', function() {
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка...';
                
                fetch('/test-data/payment-statistics', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    showResult(data.success, data.message);
                })
                .catch(error => {
                    console.error('Ошибка при получении статистики:', error);
                    showResult(false, 'Ошибка при получении статистики: ' + error.message);
                })
                .finally(() => {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-eye"></i> Показать статистику';
                });
            });

            function showResult(success, message) {
                const container = document.getElementById('resultContainer');
                const messageDiv = document.getElementById('resultMessage');
                
                container.style.display = 'block';
                messageDiv.className = success ? 'alert alert-success' : 'alert alert-danger';
                messageDiv.innerHTML = `
                    <i class="fas fa-${success ? 'check-circle' : 'exclamation-circle'}"></i>
                    ${message}
                `;
                
                // Автоматически скрыть через 10 секунд
                setTimeout(() => {
                    container.style.display = 'none';
                }, 10000);
            }
        });
    </script>
</body>
</html> 