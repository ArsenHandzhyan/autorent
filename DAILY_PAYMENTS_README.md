# Система ежедневных платежей за аренду автомобилей

## Обзор

Система автоматического списания средств за аренду автомобилей с учетом настроек счета пользователя. Каждый день с активной аренды списывается стоимость аренды за сутки.

## Основные компоненты

### 1. Модель DailyPayment
- **Поля**: аренда, счет, дата платежа, сумма, статус, время создания/обработки, примечания
- **Статусы**: PENDING, PROCESSED, FAILED

### 2. DailyPaymentService
Основной сервис для управления ежедневными платежами с логикой валидации:

#### Логика обработки платежей:
- **Если разрешен отрицательный баланс** (`allowNegativeBalance = true`):
  - Проверяется кредитный лимит (`creditLimit`)
  - Если кредитный лимит превышен → платеж FAILED
  - Если кредитный лимит не превышен → списание происходит, баланс может стать отрицательным
  
- **Если отрицательный баланс не разрешен** (`allowNegativeBalance = false`):
  - Проверяется достаточность средств
  - Если средств недостаточно → платеж FAILED
  - Если средств достаточно → списание происходит

#### Основные методы:
- `createDailyPaymentsForActiveRentals()` - создание платежей для активных аренд
- `processDailyPayments()` - обработка ожидающих платежей
- `processPayment()` - обработка конкретного платежа с валидацией
- `validatePayment()` - валидация платежа с учетом настроек счета

### 3. PaymentNotificationService
Сервис для отправки уведомлений:

#### Типы уведомлений:
- **Успешное списание** - пользователю о списании средств
- **Неудачный платеж** - пользователю и администратору о проблеме
- **Низкий баланс** - предупреждение о недостатке средств

#### Каналы уведомлений:
- Email (HTML-письма)
- SMS (если указан номер телефона)

### 4. ScheduledTasks
Планировщик задач:
- **00:01** - создание ежедневных платежей
- **00:05** - обработка платежей
- **06:00** - повторная обработка неудачных платежей

## Логика работы

### 1. Создание платежей
```java
// Ежедневно в 00:01
createDailyPaymentsForActiveRentals(LocalDate.now())
```

### 2. Обработка платежей
```java
// Ежедневно в 00:05
processDailyPayments(LocalDate.now())
```

### 3. Валидация и списание
```java
PaymentValidationResult validation = validatePayment(account, paymentAmount);
if (validation.isValid()) {
    // Списание средств
    accountService.updateBalance(userId, paymentAmount.negate());
    // Уведомление пользователя
    notificationService.sendPaymentProcessedNotification(payment);
} else {
    // Платеж FAILED
    // Уведомления пользователю и администратору
}
```

## Настройки счета пользователя

### Поля Account:
- `balance` - текущий баланс
- `allowNegativeBalance` - разрешение отрицательного баланса
- `creditLimit` - кредитный лимит (если разрешен отрицательный баланс)

### Сценарии обработки:

#### Сценарий 1: Отрицательный баланс разрешен
```
allowNegativeBalance = true
creditLimit = 10000 ₽
balance = 5000 ₽
paymentAmount = 3000 ₽

Результат: ✅ Списание происходит
Новый баланс: 2000 ₽
```

#### Сценарий 2: Превышен кредитный лимит
```
allowNegativeBalance = true
creditLimit = 10000 ₽
balance = -8000 ₽
paymentAmount = 3000 ₽

Результат: ❌ Платеж FAILED
Причина: "Превышен кредитный лимит. Доступно: 2000 ₽, требуется: 3000 ₽"
```

#### Сценарий 3: Отрицательный баланс не разрешен, средств достаточно
```
allowNegativeBalance = false
balance = 5000 ₽
paymentAmount = 3000 ₽

Результат: ✅ Списание происходит
Новый баланс: 2000 ₽
```

#### Сценарий 4: Отрицательный баланс не разрешен, средств недостаточно
```
allowNegativeBalance = false
balance = 2000 ₽
paymentAmount = 3000 ₽

Результат: ❌ Платеж FAILED
Причина: "Недостаточно средств на счете. Баланс: 2000 ₽, требуется: 3000 ₽. 
Обратитесь к администратору для пополнения счета или разрешения отрицательного баланса."
```

## Уведомления

### Пользователю при успешном списании:
- Email с деталями платежа
- SMS с краткой информацией
- Информация о новом балансе

### Пользователю при неудачном платеже:
- Email с причиной ошибки и рекомендациями
- SMS с кратким описанием проблемы
- Инструкции по решению (пополнение счета или обращение к администратору)

### Администратору при неудачном платеже:
- Email с полной информацией о платеже
- Контактные данные пользователя
- Рекомендуемые действия
- Ссылка на детали аренды в админ-панели

## API

### Контроллер DailyPaymentController

#### Веб-интерфейс:
- `GET /admin/payments` - список всех платежей
- `GET /admin/payments/rental/{rentalId}` - платежи по аренде
- `POST /admin/payments/{paymentId}/process` - ручная обработка платежа
- `POST /admin/payments/{paymentId}/retry` - повторная обработка

#### REST API:
- `GET /api/payments` - список платежей
- `GET /api/payments/{id}` - детали платежа
- `GET /api/payments/rental/{rentalId}` - платежи по аренде
- `POST /api/payments/{id}/process` - обработка платежа

## Безопасность

- Все операции с платежами выполняются в транзакциях
- Логирование всех операций
- Валидация данных на всех уровнях
- Проверка прав доступа в контроллерах

## Мониторинг

### Логи:
- Создание платежей
- Обработка платежей
- Ошибки валидации
- Отправка уведомлений

### Метрики:
- Количество созданных платежей
- Количество обработанных платежей
- Количество неудачных платежей
- Общая сумма списанных средств

## Возможные улучшения

1. **Уведомления в реальном времени** - WebSocket для мгновенных уведомлений
2. **Автоматическое пополнение** - интеграция с платежными системами
3. **Гибкие настройки** - возможность настройки времени обработки платежей
4. **Аналитика** - детальная статистика по платежам
5. **Экспорт данных** - выгрузка отчетов по платежам
6. **Интеграция с CRM** - автоматическое создание задач при проблемах с платежами

## Тестирование

### Unit тесты:
- Валидация платежей
- Расчет стоимости
- Обработка различных сценариев

### Integration тесты:
- Создание и обработка платежей
- Отправка уведомлений
- Работа с базой данных

### End-to-end тесты:
- Полный цикл от создания до обработки платежа
- Проверка уведомлений
- Тестирование админ-интерфейса 